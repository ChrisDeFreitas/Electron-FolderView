<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Lang" content="en">
<meta name="author" content="Chris DeFreitas">
<meta http-equiv="Reply-to" content="chrisd@europa.com">
<title>Folder View - folderDisplayed</title>

<link rel="stylesheet" href="file:///C:/website/node/imageView/lib/photoswipe.css">
<link rel="stylesheet" href="file:///C:/website/node/imageView/lib/default-skin/default-skin.css">
<script src="file:///C:/website/node/imageView/lib/photoswipe.js"></script>
<script src="file:///C:/website/node/imageView/lib/photoswipe-ui-default.js"></script>
<!--electron_comment_begin-->
<script src="file:///C:/website/node/imageView/lib/isotope.pkgd.js"></script>
<script src="file:///C:/website/node/imageView/lib/packery-mode.pkgd.js"></script>
<!--electron_comment_end-->

<script src="file:///C:/website/node/imageView/lib/cls_dlgFactory.js"></script>

<script>
var isElectron=false
var gallery=null	//photoswipe slideshow
var galleryScrollTimer = null
var galleryDelay=2
var exts={}
var gExtFilter={}
var isotope = null
var defaultImageNum=null
var itemselected=null
var devtools=null
var fontSize='12px'
var lastLayoutMode=null
var scale=1
var shuffle=false
var scrollTimer=null
var scrollDir=null
//var objprefix = ['img','obj','vid']
var objprefix = ['aud','fld','img','svg','unk','vid']
var imgtypes =['.bmp','.ico','.gif','.jpg','.jpeg','.png']
//var medtypes = ['.avi','.flc','.flv','.mkv','.mov','.mp3','.mp4','.mpg','.mov','.ogg','.qt','.swf','.wma','.wmv']
var vidtypes = ['.avi','.flc','.flv','.mkv','.mov','.mp4','.mpg','.mov','.ogg','.qt','.swf','.webm','.wmv']
var audtypes = ['.flac','.mp3','.wma']
var items=null

//nodejs_comment_begin
//code for electron only
const Isotope = require('isotope-layout')
const packery = require('isotope-packery')
//const horiz 	= require('isotope-horizontal')

//default electron/nodejs code for this app
const renderer = require('C:/website/node/imageView/lib/renderer.js')
renderer.sayhey()
renderer.mainMenuGen(exts, lastLayoutMode)
renderer.contextMenuSet(exts)
require('electron').ipcRenderer.on('applog', (event, message) => {
//support logging from main thread, because console.log doesn't work without debuggerer
  console.log(message)
})
//nodejs_comment_end

function init() {
	Object.assign(gExtFilter, exts)	//clone
	if(lastLayoutMode===null) lastLayoutMode="wall"
	console.log(`devtools: ${devtools}`)
	console.log(`fontsize: ${fontSize}`)
	//console.log(`layout: ${lastLayoutMode}`)
	//console.log(`scale: ${scale}`)
	//console.log(`shuffle: ${shuffle}`)
	console.log('items:', items)
	console.log('exts:', exts)	//=== gExtFilter
	if(fontSize!=='12px'){
		var griditem = findRule('.grid-item')
		if(griditem !== false) {
			griditem.style.fontSize = fontSize
		}
		else
			console.log('Font-size not changed; .grid-item style not found.')
	}
	document.addEventListener('keydown', (event) => {
		const key = event.key;
	  if (event.ctrlKey===false) return
		switch (event.key) {
    case "ArrowUp":		//zoom slideshow image up
      if(gallery==null) return
			var sc = gallery.getZoomLevel()
			sc += 0.1
			gallery.zoomTo(sc, {x:gallery.viewportSize.x/2*scale,y:gallery.viewportSize.y/2*scale}, 333)
      break;
    case "ArrowDown":		//zoom slideshow image down
			if(gallery==null) return
			var sc = gallery.getZoomLevel()
			sc -= 0.1
			gallery.zoomTo(sc, {x:gallery.viewportSize.x/2*scale,y:gallery.viewportSize.y/2*scale}, 333)
      break;
    case "ArrowRight": galleryPlay(true); break;
    case "ArrowLeft": galleryPlay(false); break;
  	}
	}, false);

	//dlgFactory.msg('Hi Chris!')
	loadFunc(lastLayoutMode)
	//pageScroll()
}
function loadFunc(layoutMode, extFilter) {
	console.log(`grid settings: `)
	console.log(`filter=`, extFilter)
	console.log(`layout mode=`, lastLayoutMode)
	console.log(`scale=`, scale)
	console.log(`shuffle=`, shuffle)

	if(shuffle==true){
		items = arrShuffle(items)
		shuffle=false
	}
	if(layoutMode===undefined)	layoutMode='wall'
	lastLayoutMode = layoutMode
	var layout=null
	if(layoutMode==='cols')	layout='masonry'
	if(layoutMode==='rows')  layout='fitRows'
	if(layoutMode==='vertical')	layout='vertical'
	if(layoutMode==='vert')	layout='vertical'
	if(layoutMode==='wall') 	layout='packery'

	if(extFilter===undefined) extFilter = gExtFilter
	else gExtFilter = extFilter

	var html = ''
	for(var idx in items){	//define grid items
		items[idx].pid = idx	//reset in case of shuffle=true
		obj = items[idx]
		if(extFilter[obj.type]===undefined) continue

		//general dimenensions
		var width =Math.floor(obj.w *scale)
		var height=Math.floor(obj.h *scale)

		//scale to ~h=200 x w=300, depending on obj type and layout mode
		var divisor = 1
		if(layout==='masonry' //cols, resize width=300px
		|| layout==='vertical') {
			divisor = obj.w/300
		}else
		if(layout==='fitRows') {		//rows
			divisor = obj.h/300
		}else { //packery (wall)
			if(obj.w >= 4000)	//resize to maintain relative sizes
				divisor = 7.5
			else
			if(obj.w >= 2000)
				divisor = 5.5
			else
			if(obj.w >= 1000)
				divisor = 3
			else
			if(obj.w >= 400)
				divisor = 1.75
		}
		//apply user's scale argument
		divisor = divisor /scale
		var dimstr = `height:${Math.round(obj.h/divisor)}px;`
		if(imgtypes.indexOf(obj.type) >= 0) //for images scale outer div so no gaps at bottom bounding area
			html += `<div onclick="itemclick(${obj.pid});" class='grid-item' id="obj${obj.pid}" title="${obj.basename}"	style="${dimstr}">`
		else
			html += `<div onclick="itemclick(${obj.pid});" class='grid-item' id="obj${obj.pid}" title="${obj.basename}">`
		//
		if(imgtypes.indexOf(obj.type) >= 0) {
			html += `<img
				id="img${obj.pid}"	src="${obj.src}"
				width=${Math.round(obj.w / divisor)}
				height=${Math.round(obj.h / divisor)}
				title="${obj.basename}, ${obj.w} x ${obj.h} (WxH)"
				onclick="openPhotoSwipe(${obj.pid});"
				ondblclick="dblClick(${obj.pid})"
			></img>`
			//no filename displayed for images
		}	else
		if(obj.isDirectory===true){
			html += `<img
				id="fld${obj.pid}"	src="${obj.src}"
				alt="${obj.basename}"
				style="padding:3em 3em 1em 3em;"
				ondblclick="dblClick(${obj.pid})"
			></img>
			<div style='padding:0; margin:0 0 ${75 *scale}px 0; width:${300 *scale}px; overflow:hidden; text-overflow:ellipsis;'>${obj.basename}</div>`
		} else
		if(obj.type==='.svg'){
			html += `<img
				id="svg${obj.pid}"	src="${obj.src}"
				height=${height}	width=${width}
				alt="${obj.basename}"
				onclick="openPhotoSwipe(${obj.pid});"
				style="background-color:whitesmoke;"
			></img>`
		} else
		if(vidtypes.indexOf(obj.type) >= 0){
			html += `<video controls preload='metadata'
				id="vid${obj.pid}" src="${obj.src}"
				type="video/${obj.type.substr(1)}"
				style="height:${height}px;	width:${width}px;"
				ondblclick="dblClick(${obj.pid})"
			></video>
			<div style='padding:0; width:${300 *scale}px; overflow:hidden; text-overflow:ellipsis;'>${obj.basename}</div>`
		} else
		if(audtypes.indexOf(obj.type) >= 0){
			html += `<audio controls preload='metadata'
				id="aud${obj.pid}" src="${obj.src}"
				style="height:${height}px;	width:${width}px;"
				ondblclick="dblClick(${obj.pid})"
			></audio>
			<div style='padding:0; width:${300 *scale}px; overflow:hidden; text-overflow:ellipsis;'>${obj.basename}</div>`
		}
		else {
			html += `<img
				id="unk${obj.pid}"	src="${obj.src}"
				height=${height}	width=${width}
				alt="${obj.basename}"
				style='padding:3em 0 0 0;''
				ondblclick="dblClick(${obj.pid})"
			></img>
			<div style='padding:0; width:${300 *scale}px; overflow:hidden; text-overflow:ellipsis;'>${obj.basename}</div>`
		}
		html += '</div>'	//close div.grid-item
	}
	var grid = document.querySelectorAll('#grid')[0]
	grid.innerHTML = html
	isotope = new Isotope(grid, {
		layoutMode: layout,
		//layoutMode: 'fitRows',					//items arranged in rows
	  //layoutMode: 'vertical',					//one column
	  //layoutMode: 'masonry',					//??? Items are arranged in a vertically cascading grid
	  //layoutMode: 'packery',					//fill empty spaces
		//buggy, not used: layoutMode: 'horiz',					//one horizontal row
	  /*horiz: {
		  verticalAlignment: 0		// align to top
		},*/
		masonry: {
		  columnWidth: (300 *scale),
		  gutter: 2	//(10 *scale)
		},
		itemSelector: '.grid-item',
  	//percentPosition: true,
  	gutter: 0,
  	fitWidth: true,
  	//stagger: 30,
  	resize: true,
	});
	if(defaultImageNum != null) {	//note: --shuffle=true will this mess up
		var obj = items[defaultImageNum]
		if(imgtypes.indexOf(obj.type) >= 0) {
			openPhotoSwipe(defaultImageNum)
			defaultImageNum = null
		}
	}
}
function itemclick(pid){
	if(itemSelect(pid)===false) return
	//openPhotoSwipe(pid)
}
function itemSelect(pid){
	if(itemselected === null
	|| itemselected.pid !== pid) {	//new item
		if(itemselected !== null) {
			var ctrl =  document.getElementById(`obj${itemselected.pid}`)
			classRemove(ctrl,'gridItemSelected')
		}
		itemselected = items[pid]
		ctrl =  document.getElementById(`obj${pid}`)
		classAdd(ctrl,'gridItemSelected')
		return itemselected
	}
	//clear existing selection
	var ctrl =  document.getElementById(`obj${itemselected.pid}`)
	classRemove(ctrl,'gridItemSelected')
	itemselected = null
	return false
}
function dblClick(pid){		//launch files in OS or open folders
	if(isElectron==false) return
	var obj = items[pid]
	if(obj.isDirectory)
		renderer.fldrBrowse(obj)
	else
		renderer.openFile(obj)
}

function pageScrollToggle(boo) {
	if(boo===undefined) boo = (scrollTimer===null)
	if(boo===true) {
		scrollTimer = window.setInterval(function () {
			//console.log(`${scrollDir},  ${window.pageYOffset}, ${window.innerHeight +document.body.clientHeight}`)
			if(scrollDir===null || window.pageYOffset<=0)	//reset at top and bottom of page
				scrollDir = 1
			else
			if(window.pageYOffset>=document.body.clientHeight -window.innerHeight)
				scrollDir = -1

			window.scrollBy(0,scrollDir)
		}, 21); // scrolls every n milliseconds
	}
	else {
		clearTimeout(scrollTimer)
		scrollTimer=null
		scrollDir=null
	}
}

function openPhotoSwipe(pid) {
	if(pid===undefined) pid=0
	/*var obj = items[pid]
	if(obj.type==='.mp4'	|| obj.type==='.flv' || obj.type==='.avi'	|| obj.type==='.wmv' || obj.type==='.mov' 	) {
		warning('Can not show movies in slideshow')
		return;
	}*/
	var pswpElement = document.querySelectorAll('.pswp')[0];
	var galleryItems = [],
		defaultPid = 0
	for(var idx in items) {	//scale images
		var item=items[idx]
		if(imgtypes.indexOf(item.type) < 0) continue
		if(defaultPid===0 && pid==idx) defaultPid = galleryItems.length
		galleryItems[galleryItems.length] = {
			src: item.src,
			w: item.w *(scale<=1 ? 1 :scale),
			h: item.h *(scale<=1 ? 1 :scale),
			pid: idx	//item.pid
		}
	}
	var options = {
		bgOpacity: 0.85,
		closeOnScroll: false,
		escKey: true,
		galleryPIDs:true,
		hideAnimationDuration:333,
		history:false,
		index: defaultPid, // first slide to start with
		//mouseUsed:true,
		showAnimationDuration:333,
		showHideOpacity:false,
		//? spacing:0.8,
		timeToIdle: 4000,
	}
	gallery = new PhotoSwipe( pswpElement, PhotoSwipeUI_Default, galleryItems, options);
	gallery.listen('destroy', function() { gallery = null });
	gallery.listen('afterChange', function() {
		var pid = gallery.currItem.pid
		itemSelect(pid)
	});
	gallery.init();
}
function galleryImageScale(boo) {
	if(gallery == null)  return
	var sc = gallery.getZoomLevel()
	if(boo===true) sc += 0.1
	else sc -= 0.1
	gallery.zoomTo(sc, {x:gallery.viewportSize.x/2,y:gallery.viewportSize.y/2}, 0)
}
function galleryScale() {
	if(gallery == null || scale < 1)  return
	//console.log('galleryScale()', scale)
	//update the currently view item
	gallery.zoomTo(scale, {x:gallery.viewportSize.x/2*scale,y:gallery.viewportSize.y/2*scale}, 333)
	//update remaining items
	for(var ii in gallery.items) {
		var gitem = gallery.items[ii]
		var obj = items[gitem.pid]	//itemsFindByPid(item.pid)
		if(obj==undefined) continue
		gitem.w = obj.w * scale
		gitem.h = obj.h * scale
	}
}
function galleryPlay(boo) {
	if(galleryScrollTimer!=null) {
		clearTimeout(galleryScrollTimer)
		galleryScrollTimer=null
		return
	}
	if(gallery==null) {
		var pid = (itemselected===null ?0 :itemselected.pid)
		openPhotoSwipe(pid)
		//return
	}
	//get slideshow delay
	var options = {
		focusId: '#inpDelay',
		title: 'Set Slideshow Delay',
		body: `<label><input id=inpDelay type=number value=${galleryDelay} min=1 style='width:3em; text-align:right;' tabindex=0> seconds</label>`,
		buttons:{
			default: 'Save',
			Save: function(dlg, btnCaption){	//use clicked save delay
				galleryDelay = dlg.querySelector('#inpDelay').value
				//console.log(galleryDelay)
				dlgFactory.close(dlg)
				//start slide show
				galleryScrollTimer = window.setInterval(function () {
					if(gallery==null) {
						clearTimeout(galleryScrollTimer)
						galleryScrollTimer = null
						return
					}
					if(boo===true) gallery.next()	//gallery automatically resets index at end of list
					else	gallery.prev()

				}, galleryDelay*1000); // scrolls every n milliseconds
			}
		 }
	}
	var dlg = dlgFactory.create(options)
}
/*function itemsFindByPid(pid) {
	for(var ii in items){
		var item = items[ii]
		if(item.pid===pid) return item
	}
	return false
}*/
function arrShuffle(array) {
	//from: https://bost.ocks.org/mike/shuffle/
  var copy = [], n = array.length, i;

  // While there remain elements to shuffle…
  while (n) {

    // Pick a remaining element…
    i = Math.floor(Math.random() * array.length);

    // If not already shuffled, move it to the new array.
    if (i in array) {
      copy.push(array[i]);
      delete array[i];
      n--;
    }
  }

  return copy;
}
function findRule(selector) {
	//1. get the local styelsheet
	var stylesheet = null
	for(var key=0; key < document.styleSheets.length; key++){
		if(document.styleSheets[key].href !== null) continue
		stylesheet = document.styleSheets[key];
	}
	if(stylesheet===null){
		console.log(`findRule(${selector}) error, default stylesheet not found.`)
		return
	}
	for(var key in stylesheet.cssRules){
		var tmprule = stylesheet.cssRules[key]
		if(tmprule.selectorText===selector){
			return tmprule
		}
	}
	return false
}
function classHas(ctrl, cssclass){
	return !!ctrl.className.match(new RegExp('(\\s|^)'+cssclass+'(\\s|$)'));
}
function classAdd(ctrl,cssclass){
	if (!classHas(ctrl,cssclass))
		ctrl.className += " "+cssclass;
}
function classRemove(ctrl,cssclass){
	if (classHas(ctrl,cssclass)) {
    var reg = new RegExp('(\\s|^)'+cssclass+'(\\s|$)');
    ctrl.className=ctrl.className.replace(reg,' ');
  }
}
</script>
<style>
	body{
		background: black repeat url('file:///C:/website/node/imageView/lib/tileable-fabric-textures-1.jpg');
		background-size:auto; color:#999; font-family:sans-serif; font-size:12px; padding:0; margin:0;
		text-align:center;
	}
	#grid{ border:0; margin:0 auto; outline:0; padding:0; vertical-align:top; }
	.grid-item {
		outline:1px solid transparent;	border:1px solid transparent;
		text-align:center;	vertical-align:middle;
	}
	.grid-item:hover {border:1px solid whitesmoke}
	.gridItemSelected{border:1px solid #1ACC1A}
	img { cursor:pointer; margin:0; padding:0; border:0; outline:0; }
	video {cursor:pointer; margin:0 auto; /*height:250px*/; }
</style>
</head>
<body onload='init()'>

<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element, as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. PhotoSwipe keeps only 3 slides in DOM to save memory. -->
        <div class="pswp__container">
            <!-- don't modify these 3 pswp__item elements, data is added later on -->
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <!--button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button-->

								<!-- custom funcs -->
								<style>
									.btnGallery{background:transparent; border:0; color:#ddd; cursor:pointer; float:right; font-size:1.5em; font-weight:bold; margin:0.6em 0 0 0;}
									.btnGallery:hover{color:#fff}
								</style>
								<button class=btnGallery style="" title='Scale image by -0.1 (Ctrl+Down)' onmousedown='galleryImageScale(false)'>&minus;</button>
								<button class=btnGallery style="" title='Scale image by +0.1 (Ctrl+Up)' onmousedown='galleryImageScale(true)'>&plus;</button>
								<button class=btnGallery style="" title='Slideshow forward toggle (Ctrl+Right)' onmousedown='galleryPlay(true); event.preventDefault;'>&sc;</button>
								<button class=btnGallery style="" title='Slideshow backward toggle (Ctrl+Left)' onmousedown='galleryPlay(false); event.preventDefault;'>&pr;</button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

          </div>

        </div>

</div>

<div id=grid class="grid">&nbsp;</div>

</body>
